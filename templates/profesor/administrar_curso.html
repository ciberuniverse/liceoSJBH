{% extends "base.html" %}

{% block contenido %}

<header class="historia-header">
    <h1>Gestión Académica del Curso</h1>
    <p>
        En este espacio podrás administrar tu asignatura dentro del curso
        {{ informacion_curso.curso | upper }}, registrar evaluaciones, asignar
        notas, pasar lista de asistencia y realizar anotaciones pedagógicas,
        permitiendo un seguimiento ordenado y continuo del progreso de tus alumnos.
    </p>
</header>


<div class="container mt-4">

    <!-- Información del curso -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h4 class="fw-bold">{{ informacion_curso.curso|upper }}</h4>
            <p class="mb-1">
                <strong>Tu asignatura:</strong>
                {{ informacion_curso.materias[rut_profesor] | capitalize }}
            </p>
        </div>
    </div>
    {% if informacion_curso['alumnos_curso'] %}
    {% set asignatura = informacion_curso.materias[rut_profesor] %}

    <!-- Botones de acciones -->
    <div class="mb-3 d-flex gap-2">
        <button class="btn btn-primary" onclick="mostrar_ocultos('asignar_nota_nombre')">
            Asignar Notas
        </button>

        <button class="btn btn-success" onclick="mostrar_ocultos('pasar_lista')">
            Pasar lista
        </button>
    </div>

    <!-- Nombre de evaluación -->
    <div class="card p-3 mb-3 asignar_nota_nombre" hidden>
        <label class="form-label fw-bold">Nombre de la evaluación</label>
        <input name="nombre_nota" id="nombre_nota" class="form-control mb-2" type="text" minlength="3" maxlength="40">
        <button class="btn btn-warning" onclick="empezar_evaluar()">Empezar a evaluar</button><br>
        <button class="btn btn-danger" onclick="cancelar_evaluar()">Cancelar</button>
    </div>

    <!-- Lista de alumnos -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Tus alumnos</h5>
        </div>

        <ul class="list-group list-group-flush">

            {% for alumno in informacion_curso['alumnos_curso'] %}
<li class="list-group-item py-3">
  <div class="row align-items-start gy-3">

    <!-- COLUMNA 1: Datos del alumno -->
    <div class="col-md-4">
      <strong>{{ alumno.nombres }} {{ alumno.apellidos }}</strong><br>
      <small class="text-muted">{{ alumno.rut }}</small><br>

      <small onclick="mostrar_ocultos('anotaciones_alumno_{{ alumno.rut }}')"
        class="text-warning fw-bold d-inline-flex align-items-center mt-1"
        style="cursor:pointer;">
        <i class="bi bi-journal-text me-1"></i>Anotación
      </small>
    </div>

    <!-- COLUMNA 2: Acciones (simétricas) -->
    <div class="col-md-4">

      <!-- Pasar lista -->
      <div class="pasar_lista mb-2"
           id="lista_{{ alumno.rut }}"
           onclick="alumno_presente('{{ alumno.rut }}')"
           hidden style="cursor:pointer;">
        <span class="badge bg-danger w-100 text-center py-2">
          Marcar Presente
        </span>
      </div>

      <!-- Asignar nota -->
      <div class="asignar_nota" hidden>
        <div class="input-group input-group-sm">
          <input id="nota_{{ alumno.rut }}" type="number" inputmode="numeric"
            class="form-control text-center">
          <button class="btn btn-success"
            onclick="asignar_nota('{{ alumno.rut }}')"
            id="boton_{{ alumno.rut }}">
            <i class="bi bi-check-circle"></i>Asignar
          </button>
        </div>
      </div>

      <!-- Anotaciones inline -->
      <div class="anotaciones_alumno_{{ alumno.rut }} mt-3" hidden>
        <div class="card shadow-sm">
          <form method="POST">
            <div class="card-body p-3">

              <input name="rut_alumno" value="{{ alumno.rut }}" hidden>
              <input name="materia_alumno" value="{{ asignatura }}" hidden>

              <div class="mb-2">
                <label class="form-label fw-bold small">Asunto</label>
                <input name="asunto" type="text" minlength="4" maxlength="100"
                  class="form-control form-control-sm" required>
              </div>

              <div class="mb-2">
                <label class="form-label fw-bold small">Descripción</label>
                <textarea name="descripcion" rows="2"
                  class="form-control form-control-sm"
                  minlength="5" maxlength="500" required></textarea>
              </div>

              <div class="text-end">
                <button type="submit" id="anotacion_{{ alumno.rut }}" name="accion" onclick="ocultar('anotacion_{{ alumno.rut }}')"
                  value="anotacion_alumno"
                  class="btn btn-primary btn-sm">
                  <i class="bi bi-save me-1"></i>Guardar
                </button>
              </div>

            </div>
          </form>
        </div>
      </div>

    </div>

    <!-- COLUMNA 3: Resumen académico -->
    <div class="col-md-4">
      {% if alumno.materias and asignatura in alumno.materias %}
        {% set notas = alumno.materias[asignatura].notas %}
        {% set anotaciones = alumno.materias[asignatura].anotaciones %}
        {% set asistencia = alumno.materias[asignatura].asistencia %}

        <div class="mb-2">
          <strong>Asistencia:</strong>
          {% if asistencia %}
            <span class="badge bg-success ms-1">
              {{ asistencia | length }} Clases
            </span>
            <div class="small text-muted">
              Última: {{ asistencia[-1:] | join(", ") }}
            </div>
          {% else %}
            <span class="badge bg-danger ms-1">Sin clases</span>
          {% endif %}
        </div>

        {% if notas %}
          <div class="d-flex flex-column gap-1">
            {% for evaluacion in notas %}
              <div class="d-flex justify-content-between small">
                <span class="fw-semibold">{{ evaluacion.nombre_evaluacion }}</span>
                <span class="badge bg-light text-dark border">
                  {{ evaluacion.nota }}
                </span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <span class="badge bg-light text-dark border">Sin notas</span>
        {% endif %}
    {% else %}
            <span class="badge bg-danger ms-1">Sin clases</span>

      {% endif %}
    </div>

  </div>

{% if anotaciones %}
<div class="mt-3">

  <span onclick="mostrar('anotaciones_{{ alumno.rut }}')"
        class="badge bg-warning text-dark"
        style="cursor:pointer;">
    <i class="bi bi-eye me-1"></i> Ver Anotaciones
  </span>

  <div id="anotaciones_{{ alumno.rut }}" hidden class="mt-3">

    <div class="card shadow-sm">
      <div class="card-body p-3">

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:30%">Asunto</th>
                <th>Descripción</th>
              </tr>
            </thead>
            <tbody>
              {% for anotacion in anotaciones %}
              <tr>
                <td class="fw-semibold text-primary">
                  {{ anotacion.asunto }}
                </td>
                <td class="text-muted">
                  {{ anotacion.descripcion }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="text-end mt-3">
          <button type="button"
                  class="btn btn-secondary btn-sm"
                  onclick="ocultar('anotaciones_{{ alumno.rut }}')">
            Cerrar
          </button>
        </div>

      </div>
    </div>

  </div>
</div>
{% endif %}

</li>



            {% endfor %}

        </ul>
        {% else %}
        <div class="alert alert-info text-center m-3">
            No hay alumnos registrados para este curso.
        </div>
        {% endif %}

        <div class="asignar_nota" hidden>
            <br>
            <form method="POST" id="form_subir_notas">
                <button type="submit" id="subir_notas" name="accion" value="subir_notas" class="btn btn-primary px-4">
                    <i class="bi bi-upload me-2"></i>Subir Notas
                </button>
            </form>
            <br>
        </div>

        <div class="pasar_lista" hidden>
            <form method="POST" id="form_pasar_lista">
                <button type="submit" id="pasar_lista_boton" name="accion" value="pasar_lista"
                    class="btn btn-success px-4">
                    Dejar Presente
                </button>
            </form>
        </div>

    </div>

</div>

<script>

    let materia = "{{ informacion_curso.materias[rut_profesor] }}"

    const form_subir_notas_ = document.getElementById("form_subir_notas");
    const form_pasar_lista_ = document.getElementById("form_pasar_lista");

    let ALUMNOS_PRESENTES = []
    let NOTAS_ALUMNOS = {
        "nombre_prueba": "",
        "notas_alumnos": []
    }

    function mostrar_ocultos(clase_tag) {
        document.querySelectorAll(`.${clase_tag}`).forEach(f => f.hidden = false);
    }

    function cancelar(clase_tag) {
        document.querySelectorAll(`.${clase_tag}`).forEach(f => f.hidden = true);
    }

    function cancelar_evaluar() {
        document.getElementById("nombre_nota").disabled = false;
        document.getElementById("nombre_nota").value = "";

        cancelar('asignar_nota_nombre');
        cancelar('asignar_nota')
    }

    function alumno_presente(rut) {

        if (ALUMNOS_PRESENTES.includes(rut)) {
            ALUMNOS_PRESENTES = ALUMNOS_PRESENTES.filter(r => r !== rut)
            document.getElementById(`lista_${rut}`).innerHTML = `<span class="badge bg-danger p-2">Marcar Presente</span>`
            return
        }

        ALUMNOS_PRESENTES.push(rut)
        document.getElementById(`lista_${rut}`).innerHTML = `<span class="badge bg-success p-2">Presente</span>`
    }

    function empezar_evaluar() {
        NOTAS_ALUMNOS["nombre_prueba"] = document.getElementById("nombre_nota").value
        document.getElementById("nombre_nota").disabled = true
        mostrar_ocultos('asignar_nota')
    }

    function asignar_nota(rut) {

        const BTN_RUT = document.getElementById(`boton_${rut}`)
        let nota = document.getElementById(`nota_${rut}`).value;
        BTN_RUT.innerHTML = 'Modificar'
        BTN_RUT.setAttribute("class", "btn btn-sm btn-warning")

        let push_notas = { [rut]: nota };

        // Si ya existe una nota para este rut, la eliminamos
        if (NOTAS_ALUMNOS.notas_alumnos.some(obj => obj.hasOwnProperty(rut))) {
            NOTAS_ALUMNOS.notas_alumnos = NOTAS_ALUMNOS.notas_alumnos.filter(
                obj => !obj.hasOwnProperty(rut)
            );
        }

        // Agregamos la nueva nota
        NOTAS_ALUMNOS.notas_alumnos.push(push_notas);

        console.log(NOTAS_ALUMNOS);
    }

    // Funciones anotaciones estudiante
    function mostrar(id) {
        document.getElementById(id).hidden = false
    }

    function ocultar(id) {
        document.getElementById(id).hidden = true
    }

    form_subir_notas_.addEventListener("submit", (e) => {
        if (NOTAS_ALUMNOS.notas_alumnos.length <= 0) {
            alert("Debes guardar las notas de cada alumno primero.");
            e.preventDefault(); // aquí sí funciona
            return;
        }

        const form = e.target;
        if (!(form instanceof HTMLFormElement)) return;

        // event.submitter es el botón que disparó el submit (soportado en navegadores modernos)
        const submitter = e.submitter || form.querySelector('button[type="submit"], input[type="submit"]');

        if (!submitter) return;

        // Si ya está deshabilitado, prevenir envío adicional
        if (submitter.hidden) {
            e.preventDefault();
            return;
        }

    });

    form_subir_notas_.addEventListener("formdata", (e) => {

        const fd = e.formData;

        if (NOTAS_ALUMNOS.notas_alumnos.length <= 0) {
            alert("Debes guardar las notas de cada alumno primero.")
            e.preventDefault()
            return
        }

        const payload = {
            materia: `${materia}`,
            notas: NOTAS_ALUMNOS
        };

        fd.append("payload_json", JSON.stringify(payload));

        console.log("FormData final:", [...fd.entries()]);
    });

    form_pasar_lista_.addEventListener("submit", (e) => {
        if (ALUMNOS_PRESENTES.length <= 0) {
            alert("Debes marcar alumnos presentes primero.");
            e.preventDefault(); // aquí sí funciona
            return;
        }

        const form = e.target;
        if (!(form instanceof HTMLFormElement)) return;

        // event.submitter es el botón que disparó el submit (soportado en navegadores modernos)
        const submitter = e.submitter || form.querySelector('button[type="submit"], input[type="submit"]');

        if (!submitter) return;

        // Si ya está deshabilitado, prevenir envío adicional
        if (submitter.hidden) {
            e.preventDefault();
            return;
        }

    });

    form_pasar_lista_.addEventListener("formdata", (e) => {

        const fd = e.formData;

        const payload = {
            materia: `${materia}`,
            alumnos_presentes: ALUMNOS_PRESENTES
        };

        fd.append("payload_json", JSON.stringify(payload));

        console.log(payload)
        console.log("FormData final:", [...fd.entries()]);
    });



</script>



{% endblock %}