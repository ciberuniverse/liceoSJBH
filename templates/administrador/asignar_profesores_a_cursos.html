{% extends 'base.html' %}

{% block contenido %}

<header class="historia-header">
  <h1>Asignación de Materias por Curso</h1>
  <p>
    En esta sección podrás organizar la estructura académica del
    {{ nombre_colegio }}, asignando docentes a cada curso con sus respectivas
    materias, además de visualizar a los estudiantes inscritos para mantener
    una gestión clara y ordenada.
  </p>
</header>


{% if asignar %}
<form class="container mt-4 p-4 border rounded shadow-sm bg-light" method="POST">

    <h4 class="mb-3 text-success">
        <i class="bi bi-journal-bookmark"></i> Estas asignando materias al curso: 
        <span class="fw-bold">{{ curso['curso'] }}</span>
    </h4>

    <!-- Docentes asignados -->
    <div id="docentes_info" class="mb-3">

        {% if "profesores_asignados" in curso %}
        {% for profesor in curso['profesores_asignados'] %}

            <div id="info_curso_{{ profesor['materia'] }}" class="alert alert-secondary d-flex justify-content-between align-items-center">
                <p class="mb-0">{{ profesor['nombres'] }} {{ profesor['apellidos'] }} | {{ profesor['rut'] }} → Materia: <strong>{{ profesor['materia'] }} </strong></p>
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminar_del_curso('{{ profesor['materia'] }}')">Eliminar</button>
            </div>

        {% endfor %}
        {% endif %}
        <!-- Aquí se irán agregando los docentes con sus materias -->
    </div>

    <input name="curso_id" value="{{ curso_id }}" hidden>
    
    <!-- Selección de profesor -->
    <div class="mb-3">
        <label for="seleccion_profesor" class="form-label fw-bold">
            <i class="bi bi-person-badge"></i> Seleccionar Profesor
        </label>
        <select id="seleccion_profesor" class="form-select shadow-sm" required>
            <option value="" disabled selected>Seleccione un profesor</option>
            {% for profesor in profesores %}
            <option id="{{ profesor['rut'] }}" value="{{ profesor['rut'] }}">
                {{ profesor['nombres'] }} {{ profesor['apellidos'] }} | {{ profesor['rut'] }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="d-grid mb-4">
        <button type="submit" name="accion" value="asignar_profesores_a_cursos" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Asignar Materias
        </button>
    </div>
</form>

<!-- Lista de alumnos -->
<div class="container mt-4 p-4 border rounded shadow-sm bg-light">
<h4 class="mb-3 text-primary">
    <i class="bi bi-people"></i> Alumnos en el Curso
</h4>

<div id="alumnos_mostrar" class="mb-3">
    <div class="list-group shadow-sm">
        {% for alumno in curso['alumnos_curso'] %}
        <div class="list-group-item d-flex justify-content-between align-items-center">
            
            <!-- Información del alumno -->
            <div>
                <span class="fw-semibold">{{ alumno['nombres'] }} {{ alumno['apellidos'] }}</span>
                <span class="text-muted ms-2">| RUT: {{ alumno['rut'] }}</span>
            </div>

            <!-- Botón de acción -->
            <form method="POST" class="mb-0">
                <input name="rut_alumno" value="{{ alumno['rut'] }}" hidden>
                <input name="curso_id" value="{{ curso_id }}" hidden>
                
                <button class="btn btn-sm btn-outline-danger" name="accion" value="eliminar_alumno">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </form>
        </div>
        {% endfor %}
    </div>
</div>
</div>




<!-- Modal artesanal con estilo Bootstrap -->
<div id="materiaModal" class="modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Asignar materia al docente</h5>
                <button type="button" class="btn-close btn-close-white" onclick="cerrarModal()"></button>
            </div>
            <div class="modal-body">
                <p id="docenteSeleccionado" class="fw-bold"></p>
                <input type="text" id="materiaInput" class="form-control" placeholder="Ingrese la materia">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarMateria()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Modal artesanal con look Bootstrap */
    .modal {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-dialog {
        margin: 10% auto;
        max-width: 500px;
    }
</style>

<script>

    let profesores_materias = {% if "profesores_asignados" in curso %}{{ curso['profesores_asignados'] | tojson }}{% else %}null{% endif %}
    let materias_tmp = {% if "materias" in curso %}{{ curso['materias'] | tojson }}{% else %}null{% endif %};

    if (materias_tmp != null) {
        CURSO_INFO = { "materias": materias_tmp, "alumnos": []};
    } else {
        CURSO_INFO = { "materias": {}, "alumnos": [] };
    }

    let docenteSeleccionadoRut = null;

    function eliminar_alumno(alumno) {
        CURSO_INFO["alumnos"].pop(alumno)
        document.getElementById(`mostrar_alumno_${alumno}`).remove()
    }

    function agregar_alumno() {
        let alumno = document.getElementById("alumno").value

        if (CURSO_INFO["alumnos"].includes(alumno)) {
            alert("El alumno ya esta en este curso.")
            return
        }

        CURSO_INFO["alumnos"].push(alumno)

        document.getElementById("alumnos_mostrar").innerHTML += `
        <div id="mostrar_alumno_${alumno}" class="alert alert-info d-flex justify-content-between align-items-center">
            <span>${alumno}</span>
            <button type="button" class="btn btn-sm btn-danger" onclick="eliminar_alumno('${alumno}')">Eliminar</button>
        </div>
        `

        document.getElementById("alumno").value = ""

    }

    function agregar_docente(rut_docente) {
        if (!rut_docente) return;

        if (JSON.stringify(CURSO_INFO["materias"]).includes(rut_docente)) {
            alert("El docente ya esta realizando clases en este curso.")
            return
        }
        
        let select = document.getElementById("seleccion_profesor");
        let informacion_docente = select.options[select.selectedIndex].text;

        docenteSeleccionadoRut = rut_docente;
        document.getElementById("docenteSeleccionado").innerText = informacion_docente;

        document.getElementById("materiaModal").style.display = "block";
        console.log(CURSO_INFO)
    }

    function eliminar_del_curso(materia) {
        
        // Recorre todas las claves (keys) del objeto CURSO_INFO.materias
        for (x of Object.keys(CURSO_INFO.materias)) {

            // Si el valor asociado a la clave actual (x) coincide con la materia buscada
            if (CURSO_INFO.materias[x] == materia) {

                // Elimina esa entrada del objeto (borra la materia asignada al docente con rut = x)
                delete CURSO_INFO.materias[x];

                // Muestra en consola el estado actualizado del objeto CURSO_INFO
                console.log(CURSO_INFO);

                // Sale del bucle para no seguir iterando (ya encontró y eliminó la materia)
                break;
            }
        }

        let bloque = document.getElementById("info_curso_" + materia);
        if (bloque) bloque.remove();
    }

    function cerrarModal() {
        document.getElementById("materiaModal").style.display = "none";
    }

    function guardarMateria() {
        let materia = document.getElementById("materiaInput").value.trim().toLowerCase();
        let docente = document.getElementById("docenteSeleccionado").innerText;

        if (!materia) {
            alert("Debe ingresar una materia.");
            return;
        } else if (!/^[A-Za-z\s]+$/.test(materia)) {
            alert("El nombre de la meteria debe contener unicamente caracteres alfabeticos.");
            return;
        }
        CURSO_INFO.materias[docenteSeleccionadoRut] = materia;

        document.getElementById("docentes_info").innerHTML += `
            <div id="info_curso_${materia}" class="alert alert-secondary d-flex justify-content-between align-items-center">
                <p class="mb-0">${docente} → Materia: <strong>${materia}</strong></p>
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminar_del_curso('${materia}')">Eliminar</button>
            </div>
        `;

        document.getElementById("materiaInput").value = "";
        cerrarModal();
    }

    document.getElementById("seleccion_profesor").addEventListener("change", () => {
        let rut_profesor = document.getElementById("seleccion_profesor").value;
        agregar_docente(rut_profesor);
    });


    document.addEventListener("formdata", (e) => {
        e.formData.set("curso_informacion", JSON.stringify(CURSO_INFO));
    })

</script>
{% endif %}

{% if principal %}

<form method="POST" class="container mt-4 p-4 border rounded shadow-sm bg-light">

    <!-- Selección de curso -->
    <div class="mb-3">
        <label for="curso" class="form-label fw-bold">
            <i class="bi bi-journal-bookmark"></i> Seleccionar Curso
        </label>
        <select name="curso" id="curso" class="form-select" required>
            <option value="" disabled selected>-- Selecciona un curso --</option>
            {% for curso in cursos %}
            <option value="{{ curso['_id'] }}">{{ curso['curso'] }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Botón -->
    <div class="d-grid">
        <button name="accion" value="asignar_materias" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Asignar Materias
        </button>
    </div>

</form>


{% endif %}

{% endblock %}